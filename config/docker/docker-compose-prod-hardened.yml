version: '3.8'

services:
  citizen-reports:
    build:
      context: /root/citizen-reports
      dockerfile: Dockerfile
    image: citizen-reports:latest
    container_name: citizen-reports-app
    working_dir: /app
    volumes:
      - db_volume:/app/server
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DB_PATH=/app/server/data.db
    command: node --max-old-space-size=256 server/server.js
    
    # ðŸ”„ PolÃ­tica de reinicio robusta
    restart: unless-stopped
    
    # ðŸ“Š Health check - verifica que la app estÃ© realmente operativa
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/reportes?limit=1"]
      interval: 30s          # Verificar cada 30 segundos
      timeout: 10s           # Esperar mÃ¡ximo 10 segundos
      retries: 3             # Marcar como unhealthy despuÃ©s de 3 fallos
      start_period: 40s      # Esperar 40s antes de empezar los checks
    
    stdin_open: true
    tty: true
    
    # ðŸ“‹ Labels para Traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.citizen-reports.rule=Host(`reportes.progressiagroup.com`)"
      - "traefik.http.routers.citizen-reports.entrypoints=websecure"
      - "traefik.http.routers.citizen-reports.tls.certresolver=letsencrypt"
      - "traefik.http.routers.citizen-reports.priority=1000"
      - "traefik.http.services.citizen-reports.loadbalancer.server.port=4000"
      # HTTP â†’ HTTPS redirect
      - "traefik.http.routers.citizen-reports-http.rule=Host(`reportes.progressiagroup.com`)"
      - "traefik.http.routers.citizen-reports-http.entrypoints=web"
      - "traefik.http.routers.citizen-reports-http.priority=1000"
      - "traefik.http.routers.citizen-reports-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    
    networks:
      - traefik-network

networks:
  traefik-network:
    external: true
    name: easypanel

volumes:
  db_volume:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /root/citizen-reports/server
