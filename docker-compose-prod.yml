version: '3.8'

services:
  citizen-reports:
    build:
      context: /root/citizen-reports
      dockerfile: Dockerfile
    image: citizen-reports:latest
    container_name: citizen-reports-app
    working_dir: /app
    volumes:
      - db_volume:/app/server
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DB_PATH=/app/server/data.db
    command: node --max-old-space-size=256 server/server.js
    restart: on-failure:10
    stdin_open: true
    tty: true
    labels:
      # Traefik routing - expone en HTTPS con LetsEncrypt
      - "traefik.enable=true"
      # HTTPS Router con prioridad ALTA (1000 para garantizar que supere el error-page por defecto)
      - "traefik.http.routers.citizen-reports.rule=Host(`reportes.progressiagroup.com`)"
      - "traefik.http.routers.citizen-reports.entrypoints=websecure"
      - "traefik.http.routers.citizen-reports.tls.certresolver=letsencrypt"
      - "traefik.http.routers.citizen-reports.priority=1000"
      - "traefik.http.services.citizen-reports.loadbalancer.server.port=4000"
      # HTTP â†’ HTTPS redirect con prioridad ALTA
      - "traefik.http.routers.citizen-reports-http.rule=Host(`reportes.progressiagroup.com`)"
      - "traefik.http.routers.citizen-reports-http.entrypoints=web"
      - "traefik.http.routers.citizen-reports-http.priority=1000"
      - "traefik.http.routers.citizen-reports-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    networks:
      - traefik-network

networks:
  traefik-network:
    external: true
    name: easypanel

volumes:
  db_volume:
