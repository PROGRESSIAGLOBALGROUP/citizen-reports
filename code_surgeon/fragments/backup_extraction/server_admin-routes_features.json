{
  "file": "server/admin-routes.js",
  "backup_size": 30452,
  "current_size": 25099,
  "diff_bytes": 5353,
  "features": {
    "encryption": [
      {
        "pattern": "cifrar",
        "line": 468,
        "func_start": 468,
        "context": "\n/**\n * Descargar respaldo de la base de datos\n * GET /api/admin/database/backup\n * Query params:\n *   - encrypted=true: Cifrar backup con AES-256-GCM\n */\nexport function descargarBackupDatabase(req, res) {\n  const dbPath = resolveDbPath();\n  const timestamp = new Date().toISOString().split('T')[0];\n  const isEncrypted = req.query.encrypted === 'true';\n  const extension = isEncrypted ? '.db.enc' : '.db';\n  const filename = `citizen-reports-backup-${timestamp}${extension}`;\n  // Use a temp file in the same directory to ensure we can write to it\n  const tempPath = resolve(dirname(dbPath), `backup-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.tmp`);",
        "match": "*   - encrypted=true: Cifrar backup con AES-256-GCM"
      }
    ]
  },
  "diff_hunks": [
    "@@ -11,6 +11,7 @@\n  * - PUT    /api/admin/tipos/:id\n\n  * - DELETE /api/admin/tipos/:id\n\n  * - GET    /api/admin/database/backup\n\n+ * - GET    /api/admin/database/backup?encrypted=true (cifrado)\n\n  * - DELETE /api/admin/database/reports\n\n  * - POST   /api/admin/database/reset\n\n  */\n",
    "@@ -18,6 +19,7 @@\n import { getDb, resolveDbPath } from './db.js';\n\n import fs from 'fs';\n\n import { dirname, resolve } from 'path';\n\n+import { encryptFile } from './security.js';\n\n \n\n /**\n\n  * Crear nueva categorÃ­a\n",
    "@@ -462,11 +464,15 @@\n /**\n\n  * Descargar respaldo de la base de datos\n\n  * GET /api/admin/database/backup\n\n+ * Query params:\n\n+ *   - encrypted=true: Cifrar backup con AES-256-GCM\n\n  */\n\n export function descargarBackupDatabase(req, res) {\n\n   const dbPath = resolveDbPath();\n\n   const timestamp = new Date().toISOString().split('T')[0];\n\n-  const filename = `citizen-reports-backup-${timestamp}.db`;\n\n+  const isEncrypted = req.query.encrypted === 'true';\n\n+  const extension = isEncrypted ? '.db.enc' : '.db';\n\n+  const filename = `citizen-reports-backup-${timestamp}${extension}`;\n\n   // Use a temp file in the same directory to ensure we can write to it\n\n   const tempPath = resolve(dirname(dbPath), `backup-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.tmp`);\n\n   \n",
    "@@ -494,42 +500,44 @@\n         throw new Error('Backup file was not created');\n\n       }\n\n       \n\n-      const stats = fs.statSync(tempPath);\n\n+      // Read the backup file\n\n+      const backupData = fs.readFileSync(tempPath);\n\n+      let outputData = backupData;\n\n+      let outputSize = backupData.length;\n\n+      \n\n+      // Encrypt if requested\n\n+      if (isEncrypted) {\n\n+        console.log('ðŸ” Cifrando backup con AES-256-GCM...');\n\n+        const { encrypted, iv, authTag } = encryptFile(backupData);\n\n+        outputData = encrypted;\n\n+        outputSize = encrypted.length;\n\n+        console.log(`âœ… Backup cifrado: ${backupData.length} â†’ ${encrypted.length} bytes`);\n\n+      }\n\n       \n\n       // Log audit\n\n       if (req.usuario && req.usuario.id) {\n\n+        const tipoBackup = isEncrypted ? 'backup_cifrado_descargado' : 'backup_descargado';\n\n         db.run(\n\n           `INSERT INTO historial_cambios (usuario_id, entidad, entidad_id, tipo_cambio, razon)\n\n-           VALUES (?, 'database', 0, 'backup_descargado', 'Descarga de respaldo de BD desde panel admin')`,\n\n-          [req.usuario.id],\n\n+           VALUES (?, 'database', 0, ?, ?)`,\n\n+          [req.usuario.id, tipoBackup, `Descarga de respaldo ${isEncrypted ? 'cifrado' : 'plano'} desde panel admin`],\n\n           (err) => { if (err) console.error('Audit log error:', err); }\n\n         );\n\n       }\n\n       \n\n-      // Stream response\n\n+      // Clean up temp file\n\n+      try { fs.unlinkSync(tempPath); } catch(e) {}\n\n+      \n\n+      // Send response\n\n       res.setHeader('Content-Type', 'application/octet-stream');\n\n       res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n\n-      res.setHeader('Content-Length', stats.size);\n\n-      \n\n-      const fileStream = fs.createReadStream(tempPath);\n\n-      \n\n-      fileStream.on('close', () => {\n\n-        // Clean up temp file after stream closes\n\n-        fs.unlink(tempPath, (err) => {\n\n-          if (err) console.error('Error deleting temp backup:', err);\n\n-        });\n\n-      });\n\n-      \n\n-      fileStream.on('error', (err) => {\n\n-        console.error('Stream error:', err);\n\n-        // Clean up\n\n-        fs.unlink(tempPath, () => {});\n\n-        if (!res.headersSent) {\n\n-          res.status(500).json({ error: 'Error streaming backup file' });\n\n-        }\n\n-      });\n\n-      \n\n-      fileStream.pipe(res);\n\n+      res.setHeader('Content-Length', outputSize);\n\n+      if (isEncrypted) {\n\n+        res.setHeader('X-Encryption', 'AES-256-GCM');\n\n+        res.setHeader('X-Encryption-Note', 'Decryption requires ENCRYPTION_KEY environment variable');\n\n+      }\n\n+      \n\n+      res.end(outputData);\n\n       \n\n     } catch (error) {\n\n       console.error('âŒ Error finalizing backup:', error);\n",
    "@@ -717,3 +725,156 @@\n     });\n\n   });\n\n }\n\n+\n\n+/**\n\n+ * GET /api/admin/dashboard\n\n+ * Obtener mÃ©tricas del dashboard para administradores\n\n+ */\n\n+export function obtenerDashboardMetricas(req, res) {\n\n+  const db = getDb();\n\n+  \n\n+  // Query complejo para obtener todas las mÃ©tricas en una sola llamada\n\n+  const queries = {\n\n+    // EstadÃ­sticas generales\n\n+    general: `\n\n+      SELECT \n\n+        (SELECT COUNT(*) FROM reportes) as total_reportes,\n\n+        (SELECT COUNT(*) FROM usuarios WHERE activo = 1) as usuarios_activos,\n\n+        (SELECT COUNT(*) FROM usuarios WHERE rol = 'funcionario') as total_funcionarios,\n\n+        (SELECT COUNT(*) FROM usuarios WHERE rol = 'supervisor') as total_supervisores,\n\n+        (SELECT COUNT(DISTINCT dependencia) FROM reportes WHERE dependencia IS NOT NULL) as dependencias_activas\n\n+    `,\n\n+    \n\n+    // Reportes por estado\n\n+    porEstado: `\n\n+      SELECT estado, COUNT(*) as cantidad \n\n+      FROM reportes \n\n+      GROUP BY estado\n\n+    `,\n\n+    \n\n+    // Reportes por tipo (top 10)\n\n+    porTipo: `\n\n+      SELECT tipo, COUNT(*) as cantidad \n\n+      FROM reportes \n\n+      GROUP BY tipo \n\n+      ORDER BY cantidad DESC \n\n+      LIMIT 10\n\n+    `,\n\n+    \n\n+    // Reportes por dependencia\n\n+    porDependencia: `\n\n+      SELECT dependencia, COUNT(*) as cantidad \n\n+      FROM reportes \n\n+      WHERE dependencia IS NOT NULL\n\n+      GROUP BY dependencia \n\n+      ORDER BY cantidad DESC\n\n+    `,\n\n+    \n\n+    // Tendencia semanal (Ãºltimos 7 dÃ­as)\n\n+    tendenciaSemanal: `\n\n+      SELECT \n\n+        date(creado_en) as fecha,\n\n+        COUNT(*) as cantidad\n\n+      FROM reportes \n\n+      WHERE creado_en >= date('now', '-7 days')\n\n+      GROUP BY date(creado_en)\n\n+      ORDER BY fecha ASC\n\n+    `,\n\n+    \n\n+    // Tendencia mensual (Ãºltimos 30 dÃ­as)\n\n+    tendenciaMensual: `\n\n+      SELECT \n\n+        date(creado_en) as fecha,\n\n+        COUNT(*) as cantidad\n\n+      FROM reportes \n\n+      WHERE creado_en >= date('now', '-30 days')\n\n+      GROUP BY date(creado_en)\n\n+      ORDER BY fecha ASC\n\n+    `,\n\n+    \n\n+    // Tiempo promedio de resoluciÃ³n (reportes cerrados) - usando historial_cambios\n\n+    tiempoResolucion: `\n\n+      SELECT \n\n+        AVG(CASE WHEN h.creado_en IS NOT NULL THEN julianday(h.creado_en) - julianday(r.creado_en) ELSE NULL END) as dias_promedio,\n\n+        MIN(CASE WHEN h.creado_en IS NOT NULL THEN julianday(h.creado_en) - julianday(r.creado_en) ELSE NULL END) as dias_minimo,\n\n+        MAX(CASE WHEN h.creado_en IS NOT NULL THEN julianday(h.creado_en) - julianday(r.creado_en) ELSE NULL END) as dias_maximo\n\n+      FROM reportes r\n\n+      LEFT JOIN historial_cambios h ON r.id = h.entidad_id AND h.entidad = 'reporte' AND h.tipo_cambio = 'cierre_aprobado'\n\n+      WHERE r.estado = 'cerrado'\n\n+    `,\n\n+    \n\n+    // Cierres pendientes de aprobaciÃ³n\n\n+    cierresPendientes: `\n\n+      SELECT COUNT(*) as cantidad \n\n+      FROM cierres_pendientes \n\n+      WHERE aprobado = 0\n\n+    `,\n\n+    \n\n+    // Reportes recientes (Ãºltimas 24h)\n\n+    recientes24h: `\n\n+      SELECT COUNT(*) as cantidad \n\n+      FROM reportes \n\n+      WHERE creado_en >= datetime('now', '-24 hours')\n\n+    `,\n\n+    \n\n+    // Personal por rol\n\n+    personal: `\n\n+      SELECT \n\n+        (SELECT COUNT(*) FROM usuarios WHERE rol = 'funcionario' AND activo = 1) as funcionarios,\n\n+        (SELECT COUNT(*) FROM usuarios WHERE rol = 'supervisor' AND activo = 1) as supervisores,\n\n+        (SELECT COUNT(*) FROM usuarios WHERE rol = 'admin' AND activo = 1) as admins\n\n+    `,\n\n+    \n\n+    // Reportes por prioridad\n\n+    porPrioridad: `\n\n+      SELECT \n\n+        CASE \n\n+          WHEN tipo IN ('fuga_agua', 'colapso_drenaje', 'incendio', 'accidente_vehicular', 'riÃ±a', 'robo', 'emergencia_medica') THEN 'critica'\n\n+          WHEN tipo IN ('bache', 'alumbrado', 'semaforo', 'inundacion') THEN 'alta'\n\n+          ELSE 'normal'\n\n+        END as prioridad,\n\n+        COUNT(*) as cantidad\n\n+      FROM reportes\n\n+      GROUP BY prioridad\n\n+    `\n\n+  };\n\n+  \n\n+  const results = {};\n\n+  let completedQueries = 0;\n\n+  const totalQueries = Object.keys(queries).length;\n\n+  \n\n+  const checkComplete = () => {\n\n+    completedQueries++;\n\n+    if (completedQueries === totalQueries) {\n\n+      res.json({\n\n+        timestamp: new Date().toISOString(),\n\n+        ...results\n\n+      });\n\n+    }\n\n+  };\n\n+  \n\n+  // Ejecutar todas las queries\n\n+  Object.entries(queries).forEach(([key, sql]) => {\n\n+    if (key === 'general' || key === 'tiempoResolucion' || key === 'cierresPendientes' || key === 'recientes24h' || key === 'personal') {\n\n+      db.get(sql, (err, row) => {\n\n+        if (err) {\n\n+          console.error(`Error en query ${key}:`, err);\n\n+          results[key] = null;\n\n+        } else {\n\n+          results[key] = row;\n\n+        }\n\n+        checkComplete();\n\n+      });\n\n+    } else {\n\n+      db.all(sql, (err, rows) => {\n\n+        if (err) {\n\n+          console.error(`Error en query ${key}:`, err);\n\n+          results[key] = [];\n\n+        } else {\n\n+          results[key] = rows || [];\n\n+        }\n\n+        checkComplete();\n\n+      });\n\n+    }\n\n+  });\n\n+}\n"
  ]
}