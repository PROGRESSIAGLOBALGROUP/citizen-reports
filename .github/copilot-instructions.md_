# citizen-reports â€” AI Agent Instructions

> **Civic-tech heatmap platform** for municipal incident reporting (Mexico)  
> React 18 + Leaflet | Express 4 + SQLite | Docker on Ubuntu VPS

---

## ğŸš€ Quick Start

```powershell
# 1. Backend (REQUIRED: init creates data.db from schema.sql)
cd server && npm install && npm run init && npm run dev  # :4000

# 2. Frontend (separate terminal)
cd client && npm install && npm run dev                   # :5173 â†’ proxies /api to :4000

# 3. Validate (TDD: Red â†’ Green â†’ Refactor)
npm run test:all   # Lint + Jest + Vitest + Playwright â€” must pass 100% before commit
```

---

## ğŸ—ï¸ Architecture

```
client/          â†’ React SPA (Leaflet maps, hash routing: #panel, #admin, #reportar)
server/          â†’ Express API (*-routes.js pattern), SQLite singleton
tests/           â†’ backend/ (Jest), frontend/ (Vitest), e2e/ (Playwright)
docs/adr/        â†’ Architecture Decision Records (check before structural changes)
```

**â›” NEVER** cross-import between `server/` and `client/`. ESM only (`import`/`export`).

---

## ğŸ”‘ Critical Patterns

### Database â€” Always use singleton
```javascript
import { getDb } from './db.js';
const db = getDb();  // âœ… NEVER instantiate sqlite3.Database directly
```

### Auth â€” Token key matters
```javascript
localStorage.getItem('auth_token')  // âœ… NOT 'token' â€” causes silent 401s
```
Middleware chain: `requiereAuth` â†’ `requiereRol(['admin'])` â†’ handler  
Test credentials: `admin@jantetelco.gob.mx` / `admin123`

### Leaflet â€” Prevent re-renders
```javascript
const mapRef = useRef(null);  // âœ… NOT useState â€” causes infinite loops
```

### New report types â†’ Update `DEPENDENCIA_POR_TIPO` in `server/auth_middleware.js`

---

## âš ï¸ Common Errors

| Symptom | Cause â†’ Fix |
|---------|-------------|
| `SQLITE_ERROR: no such table` | DB not initialized â†’ `cd server && npm run init` |
| `401 Unauthorized` on admin | Wrong key â†’ use `localStorage.getItem('auth_token')` |
| `No se encontro supervisor` | Wrong dept â†’ use `req.usuario.dependencia` not `reporte.dependencia` |
| E2E flaky/failing | Stale build â†’ `cd client && npm run build` before tests |
| `ERR_DLOPEN_FAILED` in Docker | Windows binaries â†’ ensure `.dockerignore` has `**/node_modules` |

---

## ğŸ³ Docker Deployment

```powershell
# Build (MUST use --platform + --no-cache for cross-platform)
docker build --platform linux/amd64 --no-cache -t citizen-reports:latest .

# Deploy to production (145.79.0.77)
docker save citizen-reports:latest -o "$env:TEMP\citizen-reports.tar"
scp "$env:TEMP\citizen-reports.tar" root@145.79.0.77:/tmp/
ssh root@145.79.0.77 "docker load -i /tmp/citizen-reports.tar && cd /root/citizen-reports && docker compose -f docker-compose.prod.yml up -d"
```

**Pre-flight:** Verify `.dockerignore` contains `**/node_modules` (prevents Windows sqlite3 binaries in Linux container)

---

## ğŸ“ File Placement (`.meta/FILE_STRUCTURE_PROTOCOL.md`)

| Type | Location |
|------|----------|
| Backend code | `server/` |
| Frontend code | `client/` |
| Tests | `tests/{backend,frontend,e2e}/` |
| Documentation | `docs/{guides,technical,deployment,adr}/` |
| Scripts | `scripts/` |

**ğŸš« Root directory:** Only README.md, package.json, CHANGELOG.md, config files

---

## ğŸ“š Key References

| Resource | Path |
|----------|------|
| Database schema (9 tables) | `server/schema.sql` |
| API specification | `docs/api/openapi.yaml` |
| Validation helpers | `validarCoordenadas()`, `normalizeTipos()` in `server/app.js` |
| Auth middleware | `server/auth_middleware.js` (includes `DEPENDENCIA_POR_TIPO`) |
| Architecture decisions | `docs/adr/ADR-*.md` |
